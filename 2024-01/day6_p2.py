_input_sm= """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
""".strip()

_input_lg = """
.........#...................................................................................................#.................#..
...........................#.......................................#..............................................................
.............#.................................................................................#............................#.....
...#.....................#.......#....................................#..............#.............................#...........#.#
..........#.....#..#.....#.............#..................#............#.....#........#.#.......#............................#....
...#...................#..........#...................#.........#..#..............##.......................................#......
..................................................................................................#...............................
...............#.........#....#.#..#.........#...........#...#....................#.........#.......#....#........................
..........................................#......#.#...................................................#.............#............
....................#............................#..........................................#.....................#.........#.....
..............#..................................#................#..#...........................................#................
.........#....###.......#........................................................................................#.#.....#...#..#.
.#....................................#.....................................#.................................#..................#
........................#...................................#.#....................#......##.#.........#..........................
............#.......#..................#..........................................................................................
....#.............#.#.....#...#.....#......................#...............#............##...#....................................
...#....#.....................................##........#........#....##.....................................#....................
...........................................................................#........#..........##................................#
..............................#.#......................#..........................#..#........#...............................#...
..............#.........###.......................................#...........#...............#......#.........#........#.....#...
............#............................#....................#........................#............#.............................
.........................................#.....................................................#.....#...............#............
.#...##.......................#.......#..........................................................................#...#...........#
....#..............#............#......#........................#.......................#...#.......................#.............
.......#...............#......#......#..........................................#..................#....................#...#.....
.......................................................................#.........#................................................
.#.......#........................................................##..............................................................
.........................#...................#..#......##..................................#......#......#........................
......................................#..............................................#......#..........#.#.........#..............
.....#..............#..#........#..............................#...##.............................................................
..##............................#.......................................................#..........#..............................
...........................................................##................................................#....................
#...............#.........#.....................................................#......................###........................
#.#.......................#........................#..#.....................#....#........#........................#...#.........#
............#.............#.#............#........................#..........#....................................................
............#...................#.....................................................................................#.......#...
.............................#...#..#...........................#...#.........................................................#...
........#.......................##..........................................................#.........#.....................#.....
............##............#..........................................................#.#.....#......#.#.......#...................
...........#.....#......#.................#.............#......................................#.....#...#........................
#............#.........#.......##.....#......#...........#...........#.......#................#...................................
......#..#...#.....#................................................#............#...#..........^.................................
............................................................................................................#....#................
......................................#.............................#........................#...............#.....#...#..........
...#.........................................................................#....................................................
.....................................#.........................................................#.............#.........#..........
#..............................#...#.................................#............................................................
..........#..................#............#.......#...........................#...................#.....#.........................
............................#...##.............................................................#............#.....................
.................#..................................................................#..#..............#...........................
..................#...............................#................#............#...........#......#............#.................
.....#......................#..............#.......................#......................#.......................................
...............................#.....#.......................#.......#......................#......#............#...........#.....
......#.............##....#.....#...............#.....#............................#....................................#.........
...#.#.......#..#...##.............................................................#.#.#...........#.....#................#.......
...........................................#...#......#...........................................................................
.........#.................................#........................................................................#........#.#..
........................#..........................................#.......#..............#.......................................
....................................................#...............#..........................#..................................
............................#................#......#...............#.....................#.......................................
#.#............#......................................................................................#.....#.....................
................................................................#....#..........................................#........#......#.
.......#........#......................................................................#.................#..................#.#...
...............................#...#......................................................................#.........#.........#...
...........#..#..................##..#.........................................#..............##............................#.....
#........#...............#.....#.....#.................#............#....#.............................#.......#.................#
...............#...................................................#.......#.......................#......#.............#.........
...#............................................................................................................................#.
#.....................#......................................................#...........................................#........
...........#..........................................#.......................................#.....................#.............
....#.##.......#..............#.....#..............................#....................................#.....................#...
...............................................................................................................#...............#..
.#...........................#...#.....#...#...................#....#........#.........#................................#.........
.................#............................................................................#........................#..#.......
.............#....#.....................................................#............#.........................#.......#..........
#....#........................#....................................................................##.............................
...#.#.....................................#...............................................#.....................#....#.........#.
.........#..............................#....................................#.................#............#.....................
................................................................#.................................................................
#.......#..............................................#.............................#...........#................................
.#......#.........#.............................#...............................................................#.................
.........#.....#......#.......................................................................................................#...
#..............................#........#............................#.................................#.....#.....#..............
......#.....................................#.......#........#....................................................................
#.......#.....................................#......................................................................#............
.....................................#......................................#......#.##..................#.....#.#................
.......................#.........#......#...........................................................................##............
.....#......#.#.................................................#.............................#............#.#.......#............
..................#.......................................#.#.............................#..................................#....
......................#.......#.....................#...................#......#.........................................#........
.........#...................................................................................................#....#...............
.........................#...........#..........#...............#.....#...................................................##......
#...#......#.#.....................#..................#.................#..................#......................................
..............................#.....#................#.....................#............#...#....#............#...#...............
.........................#..................#.............................................................................#.......
.......#....................#.......................#.....................#..........#...........#..........#...................#.
....#..........#..#................#.....#..........#........#..................#.....................##...............#.........#
.....................................................................................#......................................#.....
.......................................#...................................#.......................#..........................#...
.......#...............................#............#.....#..............................................#.................#......
.#..........................#..................................................................#...#.#.......#.#..........#.......
#...............................................................#.#............................#...............#......#...........
...#..........................#.#..#.#.............................................................#......#.......................
..................#........#.....................................................#...............................................#
....................#.............#.........#........##................#.............#............#..#............................
.........................#.................................#...........................................#.....#....................
..........................................##..........#................................#........................................#.
.................................................................................#..........#....................##........##.....
.....###......#.....#...................................................................................#..#...................#..
........#.....#.....#.....#..........#.................................................#.#......................#.................
...........................................#....#..............#..#..............#................................................
....#.............#...................................#.....#........................................................#............
.........#........#.............#..................#..........#..........................###.......#....#.#.#.....................
..................#....................#...................#...#..................................................................
.......#...............#................................................................................#................#........
....#..........................#......#....................................#.............#...#......................#...#.........
.#..#....................#.....................#.............#...............................#....................#....##.........
..#..#........#......#.................##..#.......#....................#.............................................#...........
..................#......#.............#.##.................................##.....................................#...#..........
.#...##........#........................................................................................#.....#...#....#..........
............#........................#............................................#.........#.............#.......................
................#......#........#...........................................................#............#........................
..............................#.#......#................................#...........#......................................#......
...................#...................#.............#............#.............#.................................................
.........#.......#....#........#.........#.....................#..#.......#..#...#.............................#..................
.........#...#.........................................................................#.....#.......#............................
.........................#..........#...............................................#.....................................#....#..
....#..................##..##...........#.........#..................................................#...#...........#...........#
.......#.......#.....#...............#.#.....#.............#........................#..............................#..#.........#.
........................#........................................#.............................##.................................
""".strip()

from pprint import pp


def parse(raw):
	out = {}
	guard_pos = None
	for row,line in enumerate(raw.split("\n")):
		for col,char in enumerate(line):
			out[col,row] = char
			if char in "^V><":
				guard_pos = (col, row)
	return out, guard_pos, col+1, row+1


def update(state, guard_pos):
	guard_dir = state[guard_pos]

	x, y = guard_pos
	if guard_dir == "V":
		new_pos = x, y+1
		new_dir = "<"
	elif guard_dir == "^":
		new_pos = x, y-1
		new_dir = ">"
	elif guard_dir == "<":
		new_pos = x-1, y
		new_dir = "^"
	elif guard_dir == ">":
		new_pos = x+1, y
		new_dir = "V"
	
	char = state.get(new_pos)
	if char == "#":
		state[guard_pos] = new_dir
		return guard_pos

	state[guard_pos] = "X"
	if char is None:
		return None

	state[new_pos] = guard_dir
	return new_pos
	


def print_map(state, w, h):
	for y in range(h):
		for x in range(w):
			char = state[x,y]
			print(char, end="")
		print()


class CycleExc(Exception):
	pass


def solve(state, guard_pos, w, h):
	visited = set()
	state = state.copy()

	while guard_pos is not None:
		guard_dir = state[guard_pos]
		dupe_key = guard_pos, guard_dir
		if dupe_key in visited:
			raise CycleExc("Cycle")
		visited.add(dupe_key)

		#print_map(state, w, h)
		#input("Press enter to continue")
		guard_pos = update(state, guard_pos)

	return state
		

def main(puzzle_input):
	start_state, guard_pos, width, height = parse(puzzle_input)
	count = 0
	num_attempts = width*height
	cur_attempt = 0

	for y in range(height):
		for x in range(width):
			cur_attempt += 1
			print(f"{cur_attempt} of {num_attempts}")

			if (x,y) == guard_pos:
				continue
			if start_state[x,y] == "#":
				continue

			state = start_state.copy()
			state[x,y] = "#"
			try:
				solve(state, guard_pos, width, height)
			except CycleExc:
				count += 1
	print(count)

	
_input_test = """
.#..
#^.#
..#.
""".strip()

if __name__ == "__main__":
	#main(_input_test)
	#main(_input_sm)
	main(_input_lg)
